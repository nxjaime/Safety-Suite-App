# -------------------------------------------------------------------
# Example: Loki Mode Code Review on Pull Requests
#
# This workflow demonstrates how to use the loki-mode GitHub Action
# to run automated multi-agent code reviews on pull requests.
#
# To use this in your own repository:
#   1. Copy this file to .github/workflows/loki-review.yml
#   2. Uncomment the entire workflow below
#   3. Set your AI provider API key as a repository secret
#   4. The action installs loki-mode and Claude Code CLI automatically
#
# Prerequisites:
#   - An API key for your chosen AI provider, set as a GitHub secret:
#     For Claude: ANTHROPIC_API_KEY (recommended)
#     For Codex: OPENAI_API_KEY
#     For Gemini: GOOGLE_API_KEY
#   - The github_token input is required for posting PR comments.
#   - The action automatically installs loki-mode and the provider CLI.
#
# Available inputs:
#   mode           - review (default), fix, or test
#   provider       - claude (default), codex, or gemini
#   budget_limit   - Max cost in USD (default: 5.00, maps to --budget flag)
#   budget         - Alias for budget_limit
#   max_iterations - Max loki iterations (default: 3, sets LOKI_MAX_ITERATIONS)
#   prd_file       - Path to PRD file relative to repo root (optional)
#   auto_confirm   - Skip confirmation prompts (default: true)
#   install_claude - Auto-install Claude Code CLI (default: true)
#   node_version   - Node.js version (default: 20)
#   github_token   - GitHub token for PR comments (required)
#
# For more information, see:
#   https://github.com/asklokesh/loki-mode
# -------------------------------------------------------------------

# name: Loki Code Review
#
# on:
#   pull_request:
#     types: [opened, synchronize]
#     # Optional: only review changes to specific paths
#     # paths:
#     #   - 'src/**'
#     #   - 'lib/**'
#     #   - '*.ts'
#     #   - '*.js'
#
# # Prevent concurrent reviews on the same PR
# concurrency:
#   group: loki-review-${{ github.event.pull_request.number }}
#   cancel-in-progress: true
#
# jobs:
#   review:
#     runs-on: ubuntu-latest
#     # Optional: skip review for certain authors (e.g., bots)
#     # if: github.event.pull_request.user.login != 'dependabot[bot]'
#     permissions:
#       contents: read
#       pull-requests: write
#
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
#
#       - name: Run Loki Mode review
#         uses: asklokesh/loki-mode@main
#         with:
#           mode: 'review'
#           provider: 'claude'
#           budget_limit: '5.00'
#           max_iterations: '3'
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#         env:
#           # Set the API key for your chosen provider
#           ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#           # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#           # GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
#
#   # -------------------------------------------------------------------
#   # Alternative: Auto-fix mode
#   # Runs loki in fix mode and pushes corrections back to the PR branch.
#   # Use with caution -- this modifies code automatically.
#   # -------------------------------------------------------------------
#   # fix:
#   #   runs-on: ubuntu-latest
#   #   permissions:
#   #     contents: write
#   #     pull-requests: write
#   #
#   #   steps:
#   #     - name: Checkout repository
#   #       uses: actions/checkout@v4
#   #       with:
#   #         ref: ${{ github.head_ref }}
#   #         fetch-depth: 0
#   #
#   #     - name: Run Loki Mode fix
#   #       uses: asklokesh/loki-mode@main
#   #       with:
#   #         mode: 'fix'
#   #         provider: 'claude'
#   #         budget_limit: '3.00'
#   #         max_iterations: '2'
#   #         github_token: ${{ secrets.GITHUB_TOKEN }}
#   #       env:
#   #         ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
#   #
#   #     - name: Commit and push fixes
#   #       run: |
#   #         git config user.name "loki-mode[bot]"
#   #         git config user.email "loki-mode[bot]@users.noreply.github.com"
#   #         git add -A
#   #         if git diff --cached --quiet; then
#   #           echo "No fixes applied."
#   #         else
#   #           git commit -m "fix: automated corrections from loki-mode review"
#   #           git push
#   #         fi
